language: node_js
node_js:
    - 12
cache:
    directories:
        - '$HOME/.npm'
jobs:
    include:
        - stage: testing
          if: branch in (master, dev)
          script: # if this is not set, it will run npm run test
              - npm ci
              - npm run test:unit
              - npm run build
              - npm run lib
          after_success: # after test is run
              - cat ./coverage/lcov.info | coveralls
        # prerelease testing
        - stage: prerelease-testing
          if: branch = prerelease
          script: # if this is not set, it will run npm run test
              - npm ci
              - npm run test:unit
              - npm run lib
        - stage: prerelease
          # only release on prereleaze branch with specific commit message (generated by npm version)
          if: branch = prerelease AND commit_message =~ /^[0-9]*\.[0-9]*\.[0-9]*-[0-9]*$/
          before_deploy:
              - npm run lib
          deploy:
              - provider: npm
                email: '$NPM_EMAIL'
                api_key: '$NPM_TOKEN'
                skip_cleanup: true
                tag: next
                on:
                    branch: prerelease
        - stage: release
          # only release on master branch with specific commit message (generated by npm version)
          if: branch = master AND commit_message =~ /^[0-9]*\.[0-9]*\.[0-9]*$/
          before_deploy:
              - npm run build
              - npm run lib
          deploy:
              - provider: npm
                email: '$NPM_EMAIL'
                api_key: '$NPM_TOKEN'
                edge: true
                skip_cleanup: true
              - provider: pages
                edge: true
                skip_cleanup: true
                github_token: $GITHUB_TOKEN
                local_dir: dist
                on:
                    branch: master
